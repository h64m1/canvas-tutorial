<!DOCTYPE html>
<html>
	<head>
		<meta charset="utf-8" />
		<title>Canvas tutorial</title>
		<script type="text/javascript">
			function draw() {
				const canvas = document.getElementById('drag-drop')
				if (canvas.getContext) {
					// drawing code here
					const ctx = canvas.getContext('2d')
					ctx.font = '25px arial'

					let initW = 50
					let initH = 50
					let initX = 100
					let initY = 100

					let isDrag = false
					let target = -1
					let w = [initW, 0]
					let h = [initH, parseInt(ctx.font)]

					let x = [initX, initX + 2 * initW]
					let y = [initY, initX + 2 * initH]
					let relX = [0, 0]
					let relY = [0, 0]
					ctx.fillRect(x[0], y[0], w[0], h[0])

					ctx.beginPath()
					const text = 'テスト'
					// fillText start point is left bottom
					ctx.fillText(text, x[1], y[1])
					w[1] = ctx.measureText(text).width

					function onDown(e) {
						const _x = e.clientX - canvas.offsetLeft
						const _y = e.clientY - canvas.offsetTop

						for (let i = 0; i < 2; i++) {
							const minY = i === 0 ? y[i] : y[i] - h[i]
							const maxY = i === 0 ? y[i] + h[i] : y[i]

							if (
								_x >= x[i] &&
								_x <= x[i] + w[i] &&
								_y >= minY &&
								_y <= maxY
							) {
								isDrag = true
								target = i
								relX[i] = x[i] - _x
								relY[i] = y[i] - _y
								console.debug('drag start', i, _x, _y, 'rel', relX, relY)
							}
						}
					}

					function onMove(e) {
						// drag end point
						const _x = e.clientX - canvas.offsetLeft
						const _y = e.clientY - canvas.offsetTop

						if (!isDrag) {
							return
						}

						x[target] = _x + relX[target]
						y[target] = _y + relY[target]

						// clear canvas
						ctx.clearRect(0, 0, canvas.width, canvas.height)
						for (let i = 0; i < 2; i++) {
							if (i === 0) {
								ctx.fillRect(x[i], y[i], w[i], h[i])
							} else {
								ctx.fillText(text, x[i], y[i])
							}
						}
					}

					function onUp(e) {
						isDrag = false
						console.debug('drag stop', x, y)
					}

					function onOut(e) {
						isDrag = false
						console.debug('out: drag stop', x, y)
					}

					canvas.addEventListener('mousedown', onDown, false)
					canvas.addEventListener('mousemove', onMove, false)
					canvas.addEventListener('mouseup', onUp, false)
					canvas.addEventListener('mouseout', onOut, false)
				} else {
					// canvas-unsupported code here
				}
			}
		</script>
		<style type="text/css">
			canvas {
				border: 1px solid black;
			}
		</style>
	</head>
	<body onload="draw();">
		<!-- <canvas id="tutorial" width="150" height="150"></canvas> -->
		<!-- default canvas size: width=300, height=150 -->
		<!-- Providing fallback content is very straightforward: just insert the alternate content inside the <canvas> element. -->
		<!-- Browsers that don't support <canvas> will ignore the container and render the fallback content inside it. -->
		<!-- Browsers that do support <canvas> will ignore the content inside the container, and just render the canvas normally. -->
		<canvas id="drag-drop" width="1000" height="1000">
			canvas tutorial
		</canvas>
	</body>
</html>
